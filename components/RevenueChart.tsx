'use client';

import { useEffect, useState } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

export default function RevenueChart({ bookings }: { bookings: any[] }) {
  const [data, setData] = useState<any[]>([]);

  useEffect(() => {
    if (!bookings) return;

    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô
    const last7Days = Array.from({ length: 7 }, (_, i) => {
      const d = new Date();
      d.setDate(d.getDate() - (6 - i)); // ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏õ 6 ‡∏ß‡∏±‡∏ô ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      return d.toISOString().split('T')[0]; // ‡πÑ‡∏î‡πâ format "2023-10-25"
    });

    // 2. ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô
    const chartData = last7Days.map((date) => {
      const dayIncome = bookings
        .filter((b) => b.booking_date === date && b.status === 'done') // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        .reduce((sum, b) => sum + ((b.final_price || b.services?.price || 0)), 0);

      // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ (‡πÄ‡∏ä‡πà‡∏ô "25 Oct")
      const dateLabel = new Date(date).toLocaleDateString('en-US', { day: 'numeric', month: 'short' });

      return {
        name: dateLabel,
        income: dayIncome,
      };
    });

    setData(chartData);
  }, [bookings]);

  return (
    <div className="w-full h-full">
      <h3 className="font-bold text-slate-800 mb-4">üìà ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô</h3>
      <div className="h-[200px] w-full text-xs">
        <ResponsiveContainer width="100%" height="100%">
          <BarChart data={data}>
            <CartesianGrid strokeDasharray="3 3" vertical={false} />
            <XAxis dataKey="name" axisLine={false} tickLine={false} />
            <YAxis axisLine={false} tickLine={false} tickFormatter={(value) => `‡∏ø${value}`} />
            <Tooltip 
              formatter={(value: number) => [`‡∏ø${value.toLocaleString()}`, '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢']}
              contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
            />
            <Bar dataKey="income" fill="#4F46E5" radius={[4, 4, 0, 0]} barSize={30} />
          </BarChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
}